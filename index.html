<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Free Games Hub</title>
  <style>
    body { font-family: sans-serif; margin:0; background:#222; color:white; }
    header { padding:10px; background:#444; display:flex; flex-direction:column; gap:8px; }
    #gameList { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:10px; padding:10px; }
    .card { background:#333; border-radius:12px; padding:10px; cursor:pointer; transition:0.2s; }
    .card:hover { background:#555; }
    .modal, .formModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000; }
    .modal-inner, .form-inner { background:#222; padding:20px; border-radius:12px; width:80%; max-width:700px; height:80%; overflow:auto; display:flex; flex-direction:column; }
    .close { float:right; cursor:pointer; font-size:20px; }
    iframe { width:100%; height:100%; border:0; }
    button { padding:6px 12px; border:none; border-radius:8px; cursor:pointer; background:#666; color:white; margin:4px; }
    button:hover { background:#888; }
    input, textarea { width:100%; margin-bottom:10px; padding:6px; border-radius:6px; border:1px solid #444; background:#111; color:white; }
  </style>
</head>
<body>
  <header>
    <h1>Free Games Hub</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="search" type="search" placeholder="Search games...">
      <select id="kindFilter">
        <option value="all">All</option>
        <option value="browser">Browser</option>
        <option value="open">Open Source</option>
        <option value="local">Local HTML</option>
      </select>
      <button onclick="openForm()">+ Add Game (Temp)</button>
      <button onclick="requestGame()">üí° Request a Game</button>
      <button onclick="ownerLogin()">üîë Owner</button>
      <button onclick="openTheme()">üé® Theme</button>
    </div>
  </header>

  <main id="gameList"></main>

  <!-- Game Modal -->
  <div id="modal" class="modal">
    <div class="modal-inner">
      <span class="close" onclick="closeModal()">‚úñ</span>
      <h2 id="modalTitle"></h2>
      <p id="modalDesc"></p>
      <p id="modalLicense"></p>
      <a id="modalSource" target="_blank">Source</a>
      <div id="embedArea" style="flex:1;margin-top:10px;"></div>
      <div style="margin-top:10px;text-align:center;">
        <button onclick="fullscreenGame()">‚õ∂ Fullscreen</button>
      </div>
    </div>
  </div>

  <!-- Temp Add Game Form -->
  <div id="formModal" class="formModal">
    <div class="form-inner">
      <h2>Add Game (Temporary)</h2>
      <input id="fTitle" placeholder="Title"><br>
      <input id="fAuthor" placeholder="Author"><br>
      <input id="fLicense" placeholder="License"><br>
      <textarea id="fDesc" placeholder="Description"></textarea><br>
      <input id="fEmbed" placeholder="Embed URL or local HTML path"><br>
      <button onclick="saveTempGame()">Save</button>
      <button onclick="closeForm()">Cancel</button>
    </div>
  </div>

  <!-- Owner Panel -->
  <div id="ownerModal" class="formModal">
    <div class="form-inner">
      <h2>Owner Panel: Add Game</h2>
      <input id="oTitle" placeholder="Title" required>
      <input id="oAuthor" placeholder="Author">
      <input id="oLicense" placeholder="License (e.g. MIT, CC0)">
      <textarea id="oDesc" placeholder="Description"></textarea>
      <p><b>Game Source:</b></p>
      <label>Embed URL: <input id="oEmbedUrl" placeholder="https://..."></label><br><br>
      <label>Upload HTML File: <input type="file" id="oEmbedFile" accept=".html"></label><br><br>
      <button onclick="ownerSaveGame()">Save & Download Files</button>
      <button onclick="closeOwner()">Cancel</button>
    </div>
  </div>

  <!-- Theme Panel -->
  <div id="themeModal" class="formModal">
    <div class="form-inner">
      <h2>Customize Theme</h2>
      <label>Background color: <input type="color" id="bgColor"></label><br><br>
      <button onclick="applyTheme()">Apply</button>
      <button onclick="closeTheme()">Close</button>
    </div>
  </div>

  <script>
    let games = [];
    let currentIframe = null;

    // ---------------- Load Games ----------------
    async function loadGamesFolder(){
      try {
        let res = await fetch("games/index.json");
        if(res.ok){
          let files = await res.json();
          for(const f of files){
            let gRes = await fetch("games/"+f);
            if(gRes.ok){
              let g = await gRes.json();
              games.push(g);
            }
          }
        }
      } catch(e){ console.warn("No games folder index found."); }
      renderGames();
    }

    function renderGames(){
      const list = document.getElementById("gameList");
      const search = document.getElementById("search").value.toLowerCase();
      const kind = document.getElementById("kindFilter").value;
      list.innerHTML="";
      games.forEach(g=>{
        if((kind==="all"||g.kind===kind) &&
           (g.title.toLowerCase().includes(search) || g.desc.toLowerCase().includes(search))){
          let d=document.createElement("div");
          d.className="card";
          d.innerHTML="<h3>"+g.title+"</h3><p>"+(g.author||"")+"</p>";
          d.onclick=()=>openGame(g.id);
          list.appendChild(d);
        }
      });
    }

    function openGame(id){
      let g = games.find(x=>x.id===id); if(!g) return;
      modal.style.display="flex";
      modalTitle.textContent=g.title+" ‚Äî "+(g.author||"");
      modalDesc.textContent=g.desc||"";
      modalLicense.textContent="License: "+(g.license||"");
      modalSource.href=g.source||"#";
      embedArea.innerHTML="";
      if(g.embed){
        let ifr=document.createElement("iframe");
        ifr.src=g.embed;
        ifr.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-modals");
        embedArea.appendChild(ifr);
        currentIframe = ifr;
      }
    }
    function closeModal(){modal.style.display="none"; currentIframe=null;}

    function fullscreenGame(){
      if(currentIframe && currentIframe.requestFullscreen){
        currentIframe.requestFullscreen();
      }
    }

    // ---------------- Temporary Add Game ----------------
    function openForm(){formModal.style.display="flex";}
    function closeForm(){formModal.style.display="none";}
    function saveTempGame(){
      let g={
        id:"u"+Date.now(),
        title:fTitle.value,
        author:fAuthor.value,
        license:fLicense.value,
        desc:fDesc.value,
        embed:fEmbed.value,
        kind:"local"
      };
      games.push(g);
      renderGames();
      closeForm();
    }

    // ---------------- GitHub Issues Request ----------------
    function requestGame(){
      const repoOwner="YOUR_USERNAME";   // change me
      const repoName="free-games-hub";   // change me
      const title=encodeURIComponent("New Game Request");
      const body=encodeURIComponent(
        "### Game Request\\n\\n"+
        "- Title: \\n"+
        "- Author: \\n"+
        "- License: \\n"+
        "- Description: \\n"+
        "- Game URL / Embed Link: \\n\\n"+
        "_Submitted via Free Games Hub_"
      );
      const issueUrl=`https://github.com/${repoOwner}/${repoName}/issues/new?title=${title}&body=${body}`;
      window.open(issueUrl,"_blank");
    }

    // ---------------- Owner Panel ----------------
    let isOwner=false;
    function ownerLogin(){
      let pw=prompt("Enter owner password:");
      if(pw==="3853"){isOwner=true;ownerModal.style.display="flex";}
      else alert("Incorrect password!");
    }
    function closeOwner(){ownerModal.style.display="none";}

    async function ownerSaveGame(){
      const title = oTitle.value.trim();
      const author = oAuthor.value.trim();
      const license = oLicense.value.trim();
      const desc = oDesc.value.trim();

      const url = oEmbedUrl.value.trim();
      const fileInput = document.getElementById("oEmbedFile");
      let gameJson = {
        id: "g"+Date.now(),
        title, author, license, desc,
        embed: "",
        kind: "local"
      };

      if(url){
        gameJson.embed = url;
      } else if(fileInput.files.length > 0){
        const file = fileInput.files[0];
        const filename = `game-${title.replace(/\\s+/g,"_")}.html`;
        const text = await file.text();

        // Save HTML file
        let blobHtml = new Blob([text], {type:"text/html"});
        let urlHtml = URL.createObjectURL(blobHtml);
        let aHtml = document.createElement("a");
        aHtml.href = urlHtml;
        aHtml.download = filename;
        aHtml.click();

        gameJson.embed = filename;
      } else {
        alert("‚ùå Please provide either a URL or upload an HTML file.");
        return;
      }

      // Save JSON file
      let blobJson = new Blob([JSON.stringify(gameJson,null,2)], {type:"application/json"});
      let urlJson = URL.createObjectURL(blobJson);
      let aJson = document.createElement("a");
      aJson.href = urlJson;
      aJson.download = `game-${title.replace(/\\s+/g,"_")}.json`;
      aJson.click();

      alert("‚úÖ Upload the .json (and the .html if provided) to /games/ and update games/index.json");
      closeOwner();
    }

    // ---------------- Theme Customization ----------------
    function openTheme(){themeModal.style.display="flex";}
    function closeTheme(){themeModal.style.display="none";}
    function applyTheme(){
      document.body.style.background = document.getElementById("bgColor").value;
      closeTheme();
    }

    // ---------------- Init ----------------
    loadGamesFolder();
    search.oninput=renderGames;
    kindFilter.onchange=renderGames;
  </script>
</body>
</html>
